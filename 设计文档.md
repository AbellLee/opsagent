# 模型设计

数据库使用 PostgreSQL，通过 init_db.py 脚本初始化以下表：

## 用户表 (users)
- user_id: UUID 主键
- username: 用户名，VARCHAR(50)，唯一且非空
- email: 邮箱，VARCHAR(100)，唯一且非空
- created_at: 创建时间，默认当前时间戳
- updated_at: 更新时间，默认当前时间戳

## 用户会话表 (user_sessions)
- session_id: UUID 主键
- session_name: 会话名称，VARCHAR(100)，默认为"新建对话"
- user_id: 用户ID，外键关联users表
- created_at: 创建时间，默认当前时间戳
- expires_at: 过期时间
- (session_id, user_id) 组合唯一约束

## 检查点表
由 langgraph 自动生成，用于保存 Agent 的状态快照。

# API接口

主要API接口包括：

## 会话管理
- `POST /api/sessions` - 创建新会话
- `GET /api/sessions/{session_id}` - 获取会话信息
- `PUT /api/sessions/{session_id}/name` - 更新会话名称
- `DELETE /api/sessions/{session_id}` - 删除会话
- `GET /api/sessions` - 列出用户的所有会话
- `GET /api/sessions/{session_id}/messages` - 获取会话历史消息

## Agent会话
- `POST /api/sessions/{session_id}/chat` - 发送对话消息

## 用户管理
- `POST /api/users` - 用户注册
- `POST /api/users/login` - 用户登录
- `GET /api/users/profile` - 获取用户信息
- `PUT /api/users/profile` - 更新用户信息
- `GET /api/users/list` - 获取所有用户列表（调试用）
- `GET /api/users/{user_id}` - 根据用户ID获取用户信息

## 工具管理
- `GET /api/tools` - 获取所有可用工具列表

# 模块

## LLM模型初始化模块
负责LLM模型的管理和初始化
- 模型初始化: 使用langgraph的模型初始化功能，参考文档：https://langchain-ai.github.io/langgraph/agents/models/
- 多厂商模型调用: 支持配置不同的模型名称，默认使用qwen-plus
- 错误处理: 包含完整的异常处理和日志记录
- 配置管理: 支持通过环境变量或配置文件设置API密钥

## tools模块
负责工具管理
- MCP工具: 通过MCP协议集成外部工具（目前为占位符实现）
- 内置自定义工具: 包括计算器、网络搜索等内置工具
- 工具注册: 提供统一的工具注册和管理接口
- 工具分类: 区分MCP工具和自定义工具

## graph模块
负责Agent图管理
- 状态图构建: 使用StateGraph构建Agent执行流程
- 节点定义: 定义agent节点和tools节点
- 条件边: 根据模型响应决定是否执行工具
- 消息处理: 处理用户消息、模型响应和工具消息，需要支持流式输出，参考文档：https://langchain-ai.github.io/langgraph/how-tos/streaming/
- 工具路由: 解析模型响应并路由到相应工具执行

## Agent状态管理
- AgentState: 定义Agent状态结构
- MessagesState: 管理对话消息序列
- 中间步骤跟踪: 记录Agent执行过程中的中间步骤



用户创建MCP配置
  ↓
保存到数据库
  ↓
点击"重载工具"按钮
  ↓
调用 /api/mcp-configs/reload
  ↓
tool_manager.reload_mcp_tools()
  ↓
从数据库重新读取配置
  ↓
创建新的 MultiServerMCPClient
  ↓
调用 get_tools() 获取工具
  ↓
更新 tool_manager.tools
  ↓
Agent下次调用时自动使用新工具